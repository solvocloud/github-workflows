# Common reusable workflow for PR-related events.
# A reference to this workflow should be made by other repositories, in workflows that
# deal with pull requests (i.e. having "on" -> "pull_request" in their header).
#
# The idea is to have this common workflow contain whatever jobs and steps needed for all
# PR-related events.
on:
  workflow_call: {}
jobs:
  validate-pr-title:
    runs-on: ubuntu-latest
    # Don't run this step if the PR is either from dev, or to main (or both).
    if: github.base_ref != 'main' || github.head_ref != 'dev'
    steps:
      - id: extract-issue-key-from-pr
        name: Extract issue key from PR title
        uses: solvocloud/action-extract-jira-key@1.0
        with:
          input: ${{ github.event.pull_request.title }}
      - id: extract-issue-key-from-branch
        name: Extract issue key from branch name
        uses: solvocloud/action-extract-jira-key@1.0
        with:
          input: ${{ github.head_ref }}
      - id: validate-pr-title
        name: Validate PR title
        uses: solvocloud/action-validate-jira-key@1.0
        with:
          key: ${{ steps.extract-issue-key-from-pr.outputs.issue-key }}
          jiraUrl: ${{ secrets.JIRA_URL }}
          jiraEmail: ${{ secrets.JIRA_EMAIL }}
          jiraApiToken: ${{ secrets.JIRA_API_TOKEN }}
      - id: validate-branch-name
        name: Validate branch name
        uses: solvocloud/action-validate-jira-key@1.0
        with:
          key: ${{ steps.extract-issue-key-from-branch.outputs.issue-key }}
          jiraUrl: ${{ secrets.JIRA_URL }}
          jiraEmail: ${{ secrets.JIRA_EMAIL }}
          jiraApiToken: ${{ secrets.JIRA_API_TOKEN }}
  test:
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: Clone repository
        uses: actions/checkout@v3
      - id: setup-python
        name: Setup Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      - id: unit-tests
        name: Run unit tests
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install pytest
          pip install -e .
          if [ -f test-requirements.txt ]; then
            pip install -r test-requirements.txt
          fi
          pytest
